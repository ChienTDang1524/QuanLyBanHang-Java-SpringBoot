<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table-responsive {
            overflow-x: auto;
        }
        #loadingSpinner {
            display: none;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="text-center mb-4">Product Management System</h1>

    <!-- Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="searchForm" class="row g-3">
                <div class="col-md-2">
                    <input type="text" class="form-control" placeholder="Product name..." id="searchName">
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" placeholder="Sell price" id="searchPrice">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="searchBrand">
                        <option value="">All Brands</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="searchCategory">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="searchStatus">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mb-3">
        <button id="addProductBtn" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Add Product
        </button>
        <div id="loadingSpinner" class="spinner-border text-primary"></div>
    </div>

    <!-- Products Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Product Name</th>
                <th>Brand</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="productTableBody">
            <tr>
                <td colspan="6" class="text-center">Loading products...</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name*</label>
                            <input type="text" class="form-control" id="addName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color*</label>
                            <input type="text" class="form-control" id="addColor" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity*</label>
                            <input type="number" class="form-control" id="addQuantity" min="0" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Sell Price*</label>
                            <input type="number" class="form-control" id="addSellPrice" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Origin Price*</label>
                            <input type="number" class="form-control" id="addOrigin" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Brand*</label>
                            <select class="form-select" id="addBrand" required>
                                <option value="">Select Brand</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Subcategory*</label>
                            <select class="form-select" id="addSubcategory" required>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmAdd" class="btn btn-primary">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name*</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color*</label>
                            <input type="text" class="form-control" id="editColor" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity*</label>
                            <input type="number" class="form-control" id="editQuantity" min="0" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Sell Price*</label>
                            <input type="number" class="form-control" id="editSellPrice" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Origin Price*</label>
                            <input type="number" class="form-control" id="editOrigin" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Brand*</label>
                            <select class="form-select" id="editBrand" required>
                                <option value="">Select Brand</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Subcategory*</label>
                            <select class="form-select" id="editSubcategory" required>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status*</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="">Select Status</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmUpdate" class="btn btn-warning">Update Product</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global Variables
    const apiBaseUrl = 'http://localhost:8080/products';
    let products = [];
    let brands = [];
    let subcategories = [];
    let statuses = [];
    let categories = [];

    // DOM Elements
    const addModal = new bootstrap.Modal('#addProductModal');
    const editModal = new bootstrap.Modal('#editProductModal');

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('Initializing app...');
        try {
            await loadBrands();
            await loadCategories();
            await loadSubcategories();
            await loadStatuses();
            await loadProducts();
            setupEventListeners();
        } catch (error) {
            console.error('Initialization error:', error);
            alert('Failed to initialize application');
        }
    });

    // Data Loading Functions
    async function loadBrands() {
        try {
            const response = await fetch(`${apiBaseUrl}/brands`);
            brands = await response.json();
            populateDropdown('addBrand', brands);
            populateDropdown('editBrand', brands);
            populateDropdown('searchBrand', brands);
        } catch (error) {
            console.error('Error loading brands:', error);
            alert('Failed to load brands');
        }
    }

    async function loadSubcategories() {
        try {
            const response = await fetch(`${apiBaseUrl}/subcategories`);
            subcategories = await response.json();
            populateDropdown('addSubcategory', subcategories);
            populateDropdown('editSubcategory', subcategories);
        } catch (error) {
            console.error('Error loading subcategories:', error);
            alert('Failed to load subcategories');
        }
    }

    async function loadStatuses() {
        try {
            const response = await fetch(`${apiBaseUrl}/statuses`);
            statuses = await response.json();
            populateDropdown('searchStatus', statuses);

            // Load statuses for edit modal
            const editStatusResponse = await fetch(`${apiBaseUrl}/statuses-for-edit`);
            const editStatuses = await editStatusResponse.json();
            populateDropdown('editStatus', editStatuses);
        } catch (error) {
            console.error('Error loading statuses:', error);
            alert('Failed to load statuses');
        }
    }

    async function loadCategories() {
        try {
            const response = await fetch(`${apiBaseUrl}/categories-for-search`);
            categories = await response.json();
            populateDropdown('searchCategory', categories);
        } catch (error) {
            console.error('Error loading categories:', error);
            alert('Failed to load categories');
        }
    }

    async function loadProducts() {
        showLoading(true);
        try {
            const name = document.getElementById('searchName').value;
            const price = document.getElementById('searchPrice').value;
            const brandId = document.getElementById('searchBrand').value;
            const categoryId = document.getElementById('searchCategory').value;
            const statusId = document.getElementById('searchStatus').value;

            let url = `${apiBaseUrl}/search?`;
            if (name) url += `name=${encodeURIComponent(name)}&`;
            if (price) {
                url += `price=${price}&`;
                // Thêm thông báo về khoảng giá tìm kiếm
                console.log(`Searching for products with price around ${price} (within ±10%)`);
            }
            if (brandId) url += `brandId=${brandId}&`;
            if (categoryId) url += `categoryId=${categoryId}&`;
            if (statusId) url += `statusId=${statusId}&`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            products = await response.json();
            console.log('Products loaded:', products);
            renderProductTable();
        } catch (error) {
            console.error('Error loading products:', error);
            document.getElementById('productTableBody').innerHTML =
                '<tr><td colspan="6" class="text-center text-danger">Error loading products</td></tr>';
        } finally {
            showLoading(false);
        }
    }

    // Render Functions
    function renderProductTable() {
        const tbody = document.getElementById('productTableBody');

        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No products found</td></tr>';
            return;
        }

        tbody.innerHTML = products.map(product => `
            <tr>
                <td>${product.id || 'N/A'}</td>
                <td>${product.produceName || 'N/A'}</td>
                <td>${product.brands && product.brands.length > 0 ?
            product.brands.map(b => b.brandName).join(', ') : 'N/A'}</td>
                <td>${product.sellPrice ? product.sellPrice.toFixed(2) : '0.00'}</td>
                <td>
                    <span class="badge ${product.statusName === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                        ${product.statusName || 'N/A'}
                    </span>
                </td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-warning btn-edit" data-id="${product.id}">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Delete Function
    async function deleteProduct(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            try {
                const response = await fetch(`${apiBaseUrl}/${productId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Delete failed with status: ${response.status}`);
                }

                alert('Product deleted successfully');
                await loadProducts(); // Refresh the list
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product: ' + error.message);
            }
        }
    }

    // Modal Functions
    function openAddModal() {
        document.getElementById('addProductForm').reset();
        addModal.show();
    }

    async function openEditModal(productId) {
        try {
            const product = products.find(p => p.id == productId);
            if (!product) throw new Error('Product not found');

            document.getElementById('editId').value = product.id;
            document.getElementById('editName').value = product.produceName;
            document.getElementById('editColor').value = product.color;
            document.getElementById('editQuantity').value = product.quantity;
            document.getElementById('editSellPrice').value = product.sellPrice;
            document.getElementById('editOrigin').value = product.originPrice;

            // Set subcategory
            if (product.subCategoryId) {
                document.getElementById('editSubcategory').value = product.subCategoryId;
            }

            // Set brand
            if (product.brands && product.brands.length > 0) {
                document.getElementById('editBrand').value = product.brands[0].id;
            }

            // Set status
            if (product.statusId) {
                document.getElementById('editStatus').value = product.statusId;
            }

            editModal.show();
        } catch (error) {
            console.error('Error opening edit modal:', error);
            alert('Failed to load product data');
        }
    }

    // CRUD Operations
    async function addProduct() {
        const productData = {
            productName: document.getElementById('addName').value,
            color: document.getElementById('addColor').value,
            quantity: parseInt(document.getElementById('addQuantity').value),
            sellPrice: parseFloat(document.getElementById('addSellPrice').value),
            originPrice: parseFloat(document.getElementById('addOrigin').value),
            brandIds: [parseInt(document.getElementById('addBrand').value)],
            subCategoryId: parseInt(document.getElementById('addSubcategory').value),
            statusId: 1 // Default active status
        };

        try {
            const response = await fetch(apiBaseUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            });

            if (!response.ok) throw new Error('Add failed');

            addModal.hide();
            await loadProducts();
        } catch (error) {
            console.error('Error adding product:', error);
            alert('Failed to add product');
        }
    }

    async function updateProduct() {
        const productId = document.getElementById('editId').value;
        const productData = {
            productName: document.getElementById('editName').value,
            color: document.getElementById('editColor').value,
            quantity: parseInt(document.getElementById('editQuantity').value),
            sellPrice: parseFloat(document.getElementById('editSellPrice').value),
            originPrice: parseFloat(document.getElementById('editOrigin').value),
            brandIds: [parseInt(document.getElementById('editBrand').value)],
            subCategoryId: parseInt(document.getElementById('editSubcategory').value),
            statusId: parseInt(document.getElementById('editStatus').value)
        };

        try {
            const response = await fetch(`${apiBaseUrl}/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            });

            if (!response.ok) throw new Error('Update failed');

            editModal.hide();
            await loadProducts();
        } catch (error) {
            console.error('Error updating product:', error);
            alert('Failed to update product');
        }
    }

    // Helper Functions
    function populateDropdown(elementId, items) {
        const select = document.getElementById(elementId);
        const isSearch = elementId.startsWith('search');

        select.innerHTML = isSearch
            ? '<option value="">All ' + elementId.replace('search', '') + '</option>'
            : '<option value="">Select ' + elementId.replace('add', '').replace('edit', '') + '</option>';

        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            // Handle different item types
            option.textContent = item.brandName || item.subCateName || item.cateName || item.statusName || item.name;
            select.appendChild(option);
        });
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // Event Listeners
    function setupEventListeners() {
        // Add Product
        document.getElementById('addProductBtn').addEventListener('click', openAddModal);
        document.getElementById('confirmAdd').addEventListener('click', addProduct);

        // Edit Product
        document.addEventListener('click', (e) => {
            if (e.target.closest('.btn-edit')) {
                const productId = e.target.closest('.btn-edit').dataset.id;
                openEditModal(productId);
            }
        });
        document.getElementById('confirmUpdate').addEventListener('click', updateProduct);

        // Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await loadProducts();
        });
    }
</script>
</body>
</html>